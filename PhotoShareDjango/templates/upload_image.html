{% extends "base.html" %}

{% block content %}

<h2>Tải lên hình ảnh</h2>
<form class="image-upload-form" method="post" enctype="multipart/form-data">
  {% csrf_token %}
  <fieldset>
    {{ form.image.label_tag }}
    {{ form.image }}
  </fieldset>
  <fieldset>
    {{ form.caption.label_tag }}
    {{ form.caption }}
  </fieldset>
  <fieldset>
    {{ form.tags.label_tag }}
    {{ form.tags }}
  </fieldset>
  <fieldset>
    {{ form.topics.label_tag }}
    {{ form.topics }}
  </fieldset>
  <button type="submit">Tải lên</button>
</form>

<div id="progress-container" style="display: none;">
  <div id="progress-bar"></div>
  <div id="progress-text">Tải lên: <span id="progress-percent">0%</span></div>
</div>

<div id="uploaded-image" style="display: none;">
  <h3>Hình ảnh đã tải lên:</h3>
  <img id="uploaded-image-preview" src="" alt="Hình ảnh đã tải lên">
</div>
<script>
  const uploadForm = document.getElementById('upload-form');
  const imageInput = document.querySelector('input[type="file"]');
  const uploadedImagePreview = document.getElementById('uploaded-image-preview');

  // Thêm sự kiện 'change' vào trường tệp hình ảnh để hiển thị trước hình ảnh khi người dùng chọn tệp
  imageInput.addEventListener('change', function () {
    const file = this.files[0];
    if (file) {
      const reader = new FileReader();

      reader.onload = function (event) {
        uploadedImagePreview.src = event.target.result;
        uploadedImagePreview.style.display = 'block';
      };

      reader.readAsDataURL(file);
    }
  });
  function hideForm() {
    document.getElementById("upload-form").style.display = "none";

  }
  uploadForm.addEventListener('submit', function (e) {
    e.preventDefault();

    const formData = new FormData(this);

    const xhr = new XMLHttpRequest();

    xhr.upload.onprogress = function (event) {
      if (event.lengthComputable) {
        const percentComplete = (event.loaded / event.total) * 100;
        document.getElementById('progress-bar').style.width = percentComplete + '%';
        document.getElementById('progress-percent').textContent = percentComplete.toFixed(2) + '%';
      }
    };

    xhr.onreadystatechange = function () {
      if (xhr.readyState === 4 && xhr.status === 200) {
        const response = JSON.parse(xhr.responseText);
        document.getElementById('uploaded-image-preview').src = response.image_url;
        document.getElementById('uploaded-image').style.display = 'block';
        document.getElementById('progress-container').style.display = 'none';
        document.getElementById('success-link').style.display = 'block';
      }
    };

    xhr.open('POST', '{% url 'upload_image' %}', true);
    xhr.send(formData);

    document.getElementById('progress-container').style.display = 'block';
    document.getElementById('progress-bar').style.width = '0%';
    document.getElementById('progress-percent').textContent = '0%';
  });
</script>
<a href="{% url 'success_page' %}" style="display: none;" id="success-link">Đã tải lên thành công</a>

{% endblock %}